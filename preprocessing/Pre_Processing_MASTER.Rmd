---
title: "Pre_Processing_MASTER"
output: html_notebook
---

#### Clear Environment
```{r}
rm(list = ls())
```

#### Load Libraries
```{r}
library(tidyverse)
library(dplyr)
library(readxl)
library(stringr)
library(RSQLite)
library(roxygen2) # Function Documentation: ctrl + option + shift + r
```

## Load SQLite Database
```{r}
# Create a connection to our new database, CraigslistCars.sqlite3
conn <- dbConnect(RSQLite::SQLite(), "CraigslistCars.sqlite3")
```

#### List of available tables in the database
```{r}
dbListTables(conn)
```
#### Create DF called "cars"
```{r}
cars <- dbGetQuery(conn, "SELECT * FROM cars")
```
#### Convert to Tibble and Inspect first 6 Rows of Data
```{r}
cars <- as_tibble(cars)
head(cars)
```
The original data has 426,880 observations and 23 variables

#### Create Function "Number_NAs" to examine % Null Values in DataFrame
```{r}
Number_NAs <- function (df) {
  df[df == ''] <- NA # insert 'NA' into any blank string in the DF
  
  number_nas <- data.frame(num_nas = (sapply(df, function(x){sum(is.na(x))})))
  number_nas$percent_nas <- round((number_nas$num_nas / dim(df)[1]) * 100, 2)
  return (number_nas)
  
#' Title: Number_Nas
#'
#' @param: df 
#' @return: df with count and % of NA values for each column
#' @examples: Number_NAs(cars)

}
```

```{r}
num_nas <- Number_NAs(cars)
num_nas
```

Variables with Null Values > 10% include:
* condition
* cylinders
* VIN (drop from DF)
* drive
* type
* paint_color
* county (drop from DF)

#### Drop Variables that we likely won't need.
* VIN
* image_url
* county
* lat
* long

```{r}
cars <- cars %>% subset(select = c("id", "region", "price", "year", "manufacturer",
                                    "model", "condition", "cylinders", "fuel",
                                    "odometer", "title_status", "transmission",
                                    "drive", "type", "paint_color",
                                    "description", "state",
                                    "posting_date"
                                  ))
```

# Examine and Impute Data for Columns with NA Values

#### Function to quickly remove NA Values
```{r}
Remove_NAs <- function (df, col) {
  col <- df[[col]]
  df<- df %>% filter(!is.na(col))
  
return(df)
  
#' Title: remove_nas
#'
#' @param df 
#' @param col {string} column to remove NA values
#' @return df with NA values removed
#' @examples remove_nas(cars, title_status)
#'   
}
```

#### 'year' column
```{r}
cars %>% filter(is.na(year) & is.na(description))
```
In most cases, the description column contains the year of the cars; however, there are 68 rows of data that have NA values in BOTH the year and the description columns. These observations are also missing most of the variables we'll be using so we should drop these rows from the dataset.

```{r}
# Remove 68 observations where year and description have "NA" values.
cars <- cars[!(is.na(cars$year) & is.na(cars$description)), ]
```

Now let's attempt to parse out the years from the description column and impute them back into the year column. In most cases, the description lists the year first, so we'll grab the first 4 characters from the description column and create a new column 'y' to store them.
```{r}
cars %>% filter(is.na(year))
```

create a list of years to check against when imputing back to the year column.
```{r}
list_of_years = list('1990', '1991', '1992', '1993', '1994', '1995', '1996', '1997', 
                     '1998', '1999', '2000', '2001', '2002', '2003', '2004', '2005', 
                     '2006', '2007', '2008', '2009', '2010', '2011', '2012', '2013', 
                     '2014', '2015', '2016', '2017', '2018', '2019', '2020', '2021', '2022')

# get the first 4 characters
cars$y <- substr(cars$description, start = 1, stop = 4)

# assign 'y' to 'year' column IF 'year' is NA and the value of 'y' is in "list_of_years"
cars$year <- ifelse(is.na(cars$year), (ifelse(cars$y %in% list_of_years, cars$y, cars$year)), cars$year)

```

Check to see how many NA values are remaining.
```{r}
cars %>% filter(is.na(year))
```
21 - NA data points remain for the 'year' column. I don't see the year in the description and these observations are missing additional variables, so we should probably drop these remaining rows from the dataset.
```{r}
cars <- cars %>% filter(!is.na(year))
```

We can also check to compare the descriptions to the 'year' and 'y' columns after imputation.
```{r}
cars_check_years <- cars %>% subset(select = c('year', 'description', 'y'))
```
Finally, we'll drop the 'y' column now that we don't need it anymore.
```{r}
cars <- select(cars, -y)
```
Last, we'll convert the 'year' column to dtype = int
```{r}
cars$year <- as.integer(cars$year)
```

#### Create Function "Remove_Punc()" to remove unneccessary punctuation from 'description' and 'model' columns
```{r}
Remove_Punc <- function (df, col, replacement) {
  df[[col]] <- str_replace_all(df[[col]],"[[:punct:]]", replacement)
  return(df)

#' Title: Remove_Punc()
#'
#' @param df : DataFrame
#' @param col : {string} column to clean punctuation from
#' @param replacement {string} character to replace punctuation with
#'
#' @return DataFrame
#'
#' @examples Remove_Pund(cars, "description", "")
}
```

```{r}
cars <- Remove_Punc(cars, "description", " ")
cars <- Remove_Punc(cars, "model", " ")
```

#### Clean 'manufacturer' column
There are 17,557 NA values in the 'manufacturer' column. Let's try to pattern match from a list of manufacturers.
```{r}
cars %>% filter(is.na(manufacturer))
```

```{r}
manufacturer_pattern <- 'Acura|Alfa Romeo|Aston Martin|Audi|Bentley|
                      BMW|Buick|Cadillac|Chevrolet|Chrysler|Dodge|
                      Ferrari|Fiat|Ford|FORD|Freightliner|Geo|GMC|Genesis|Honda|Hummer|Hyundai|hyndai|
                      Infinity|International|Isuzu|Jaguar|Jeep|Kenworth|Kia|Land Rover|
                      Lexus|Lincoln|Mack|Maserati|Mazda|Mercedes-Benz|Mercury|
                      Mini|Mitsubishi|Nissan|Oldsmobile|OLDSMOBILE|Peugeot|peterbilt|Plymoth|Pontiac|Porsche| 
                      Ram|Saab|Saturn|Scion|Seat|Smart|Sterling|Subaru|Suzuki|
                      Tesla|Toyota|Volkswagen|Volkswagon|Volvo'
                       
```

```{r}
cars %>% filter(is.na(manufacturer))
```
First we'll try to pull the manufacturer from the model variable.
```{r}
cars$match <- ifelse(is.na(cars$manufacturer),
                          str_extract_all(cars$model, regex(manufacturer_pattern, ignore_case = TRUE), simplify = TRUE)[,1],
                          ''
                          )
```

```{r}
cars$manufacturer <- ifelse(((is.na(cars$manufacturer)) & (cars$match != '')),
                                 cars$match,
                                 cars$manufacturer
)
```

```{r}
cars %>% filter(is.na(manufacturer))
```
This gets us 8908 more manufacturers in our dataset. Next, we'll try to pull remaining missing manufacturers from the description variable

```{r}
cars <- cars %>% select(-match)
```

```{r}
cars$match <- ifelse(is.na(cars$manufacturer), 
                          str_extract_all(cars$description, regex(manufacturer_pattern, ignore_case = TRUE), simplify = TRUE)[,1],
                          ''
                          )
```

```{r}
cars$manufacturer <- ifelse(((is.na(cars$manufacturer)) & (cars$match != '')),
                                 cars$match,
                                 cars$manufacturer
)
```

```{r}
cars %>% filter(is.na(manufacturer)) %>% 
  select(c(year, manufacturer, model, description))
```
We were able to recover 11,975 manufacturers from the model and description columns. We can drop the remaining observations with missing values in the manufacturer column.
```{r}
cars <- cars %>% filter(!is.na(manufacturer))
cars <- cars %>% select(-match)
cars %>% filter(is.na(manufacturer))
```

#### 'model' column
This variable has 5208 missing values.
```{r}
cars %>% filter(is.na(model))
```
If we had more time, we could probably create a list of all known car models and perform the same steps as manufacturer; however, for this analysis, we'll just drop these rows since they only make up about 1% of the total number of observations.

```{r}
cars <- Remove_NAs(cars, "model")
cars %>% filter(is.na(model))
```

#### 'condition' column
```{r}
unique(cars$condition)
```
This seems like a good variable, so we'll just replace the NA values with 'unknown'

```{r}
cars$condition[is.na(cars$condition)] <- "unknown"
unique(cars$condition)
```

#### 'cylinders' column
```{r}
unique(cars$cylinders)
```

similar to condition, we'll replace the NA and "other" values with 'unknown'
```{r}
cars$cylinders[is.na(cars$cylinders)] <- "unknown"
cars$cylinders[cars$cylinders == 'other'] <- "unknown"
unique(cars$cylinders)
```

#### 'fuel' column
```{r}
cars %>% filter(is.na(fuel))
```
We have 2,821 observations with NA values in the 'fuel' column. Let's impute "unknown" for all NA and "other" values.

```{r}
cars$fuel[((cars$fuel == "other") | (cars$fuel == "Other") | is.na(cars$fuel))] <- "unknown"
cars %>% filter(is.na(fuel))
```

#### 'odometer' column
This is a tricky column to deal with. Odometer is likely a really good indicator, so for this dataset, I think it's best to remove all NA 4,189 values.
```{r}
cars %>% filter(is.na(odometer))
```
```{r}
# Remove observations with 'odometer' == NA
cars <- cars %>% filter(!is.na(odometer))
```

We also have quite a few suspect observations. For example, older cars with low mileage.
```{r}

mileage_filter <- (cars$year <= 2018 & cars$odometer < 500)

cars %>% filter(mileage_filter) %>%
  select(c(model, year, condition, odometer )) %>%
  arrange(desc(year))
```
#### Create a function 'Odometer_Filter()' 
This function will clean the odometer variable based on specific conditions. For example, a 2015 Toyota Camry with 200 miles is probably not accurate and we would probably want to remove these observations from the dataset. This function will allow us to quickly change the filtering when modeling.
```{r}
Odometer_Filter <- function (df, start_year, mileage, remove_na = TRUE) {

  df <- df %>% filter(!is.na(odometer))
  
  mileage_filter <- (df$year <= start_year & df$odometer < mileage)
  df <- df %>% filter(!mileage_filter)
          
  return(df)
  
#' Title: odometer_filter 
#'
#' @param df - dataframe
#' @param start_year - ex: 2018 -> filter out all cars before 2018
#' @param mileage - ex: 500 -> filter out cars with odometer values < 500
#' @param remove_na = TRUE {default}. This removes all NA values from the df
#'
#' @return a dataframe with applied filters
#'
#' @examples odometer_test <- odometer_filter(cars_test, 2018, 500)
  
}
```

Apply the 'odometer_filter' to the dataset.
```{r}
cars <- odometer_filter(cars_test, 2018, 500)
```

#### Remove NA observations in 'title_status' column
```{r}
cars %>% filter(is.na(title_status))
```
```{r}
cars <- remove_nas(cars, "title_status")
cars %>% filter(is.na(title_status))
```

```{r}
Number_NAs(cars)
```





