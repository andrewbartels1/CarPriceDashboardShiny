---
title: "Pre_Processing_MASTER"
output:
---

#### Clear Environment
```{r}
rm(list = ls())
```

#### Load Libraries
```{r}
library(tidyverse)
library(dplyr)
library(readxl) 
library(stringr) # string formatting
library(RSQLite) # to connect to SQlite database
library(roxygen2) # For Function Documentation: ctrl + option + shift + r
```

## Load SQLite Database
Create a connection to our new database, CraigslistCars.sqlite3
```{r}
#set path to the database.
db_path <- "~/Dev/Projects/MGT6203-grp-project/Database/CraigslistCarsClean.sqlite3"
  
conn <- dbConnect(RSQLite::SQLite(), db_path)
```

#### List of available tables in the database
```{r}
dbListTables(conn)
```
#### Create DF called "cars"
```{r}
cars1 <- dbGetQuery(conn, "SELECT * FROM vehicles")
```

```{r}
dbDisconnect(conn)
```

#### Convert to Tibble and Inspect first 6 Rows of Data
```{r}
cars <- cars1
cars <- as_tibble(cars)
head(cars)
```
The original data has 426,880 observations and 23 variables

#### Create Function "Number_NAs( )" to examine % Null Values in DataFrame
```{r}
Number_NAs <- function (df) {
  df[df == ''] <- NA # insert 'NA' into any blank string in the DF
  
  number_nas <- data.frame(num_nas = (sapply(df, function(x){sum(is.na(x))})))
  number_nas$percent_nas <- round((number_nas$num_nas / dim(df)[1]) * 100, 2)
  return (number_nas)
  
#' Title: Number_Nas
#'
#' @param: df 
#' @return: df with count and % of NA values for each column
#' @examples: Number_NAs(cars)

}
```

```{r}
num_nas <- Number_NAs(cars)
num_nas
```

Variables with Null Values > 10% include:
* condition
* cylinders
* VIN (drop from DF)
* drive
* type
* paint_color
* county (drop from DF)

#### Drop Variables that we likely won't need.
* VIN
* image_url
* county
* lat
* long

```{r}
cars <- cars %>% subset(select = c("id", "region", "price", "year", "manufacturer",
                                    "model", "condition", "cylinders", "fuel",
                                    "odometer", "title_status", "transmission",
                                    "drive", "type", "paint_color",
                                    "description", "state",
                                    "posting_date"
                                  ))
```

# Examine and Impute Data for Columns with NA Values

#### Create "Remove_NAs( )" Function to quickly remove NA Values
```{r}
Remove_NAs <- function (df, col) {
  col <- df[[col]]
  df<- df %>% filter(!is.na(col))
  
return(df)
  
#' Title: remove_nas
#'
#' @param df 
#' @param col {string} column to remove NA values
#' @return df with NA values removed
#' @examples remove_nas(cars, title_status)
#'   
}
```

#### Clean 'year' column
```{r}
cars %>% filter(is.na(year) & is.na(description))
```
In most cases, the description column contains the year of the cars; however, there are 68 rows of data that have NA values in BOTH the year and the description columns. These observations are also missing most of the variables we'll be using so we should drop these rows from the dataset.

```{r}
# Remove 68 observations where year and description have "NA" values.
cars <- cars[!(is.na(cars$year) & is.na(cars$description)), ]
```

Now let's attempt to parse out the years from the description column and impute them back into the year column. In most cases, the description lists the year first, so we'll grab the first 4 characters from the description column and create a new column 'y' to store them.
```{r}
cars %>% filter(is.na(year))
```

create a list of years to check against when imputing back to the year column.
```{r}
list_of_years = list('1990', '1991', '1992', '1993', '1994', '1995', '1996', '1997', 
                     '1998', '1999', '2000', '2001', '2002', '2003', '2004', '2005', 
                     '2006', '2007', '2008', '2009', '2010', '2011', '2012', '2013', 
                     '2014', '2015', '2016', '2017', '2018', '2019', '2020', '2021', '2022')

# get the first 4 characters
cars$y <- substr(cars$description, start = 1, stop = 4)

# assign 'y' to 'year' column IF 'year' is NA and the value of 'y' is in "list_of_years"
cars$year <- ifelse(is.na(cars$year), (ifelse(cars$y %in% list_of_years, cars$y, cars$year)), cars$year)

```

Check to see how many NA values are remaining.
```{r}
cars %>% filter(is.na(year))
```
21 - NA data points remain for the 'year' column. I don't see the year in the description and these observations are missing additional variables, so we should probably drop these remaining rows from the dataset.
```{r}
cars <- cars %>% filter(!is.na(year))
```

We can also check to compare the descriptions to the 'year' and 'y' columns after imputation.
```{r}
cars_check_years <- cars %>% subset(select = c('year', 'description', 'y'))
```
Finally, we'll drop the 'y' column now that we don't need it anymore.
```{r}
cars <- select(cars, -y)
```
Last, we'll convert the 'year' column to dtype = int
```{r}
cars$year <- as.integer(cars$year)
```

#### Create Function "Remove_Punc( )" to remove unnecessary punctuation from 'description' and 'model' columns
```{r}
Remove_Punc <- function (df, col, replacement) {
  df[[col]] <- str_replace_all(df[[col]],"[[:punct:]]", replacement)
  return(df)

#' Title: Remove_Punc()
#' 
#' @description: Removes unnecessary punctuation from a single DataFrame column
#' 
#' @param df : DataFrame
#' @param col : {string} column to clean punctuation from
#' @param replacement {string} character to replace punctuation with
#'
#' @return DataFrame
#'
#' @examples Remove_Pund(cars, "description", "")
}
```

```{r}
cars <- Remove_Punc(cars, "description", " ")
cars <- Remove_Punc(cars, "model", " ")
```

#### Clean 'manufacturer' column
There are 17,557 NA values in the 'manufacturer' column. Let's try to pattern match from a list of manufacturers.
```{r}
cars %>% filter(is.na(manufacturer))
```

```{r}
manufacturer_pattern <- 'Acura|Alfa Romeo|Aston Martin|Audi|Bentley|
                      BMW|Buick|Cadillac|Chevrolet|Chrysler|Dodge|
                      Ferrari|Fiat|Ford|FORD|Freightliner|Geo|GMC|Genesis|Honda|Hummer|
                      Hyundai|hyndai|Infinity|International|Isuzu|Jaguar|Jeep|Kenworth|
                      Kia|Land Rover|Lexus|Lincoln|Mack|Maserati|Mazda|Mercedes-Benz|Mercury|
                      Mini|Mitsubishi|Nissan|Oldsmobile|OLDSMOBILE|Peugeot|peterbilt|Plymoth|
                      Pontiac|Porsche|Ram|Saab|Saturn|Scion|Seat|Smart|Sterling|Subaru|Suzuki|
                      Tesla|Toyota|Volkswagen|Volkswagon|Volvo'

man_pattern_2 <- paste(c("Acura", "Alfa Romeo", "Aston Martin", "Audi", "Bentley", 
                      "BMW", "Buick", "Cadillac", "Chevrolet", "Chrysler", "Dodge",
                      "Ferrari", "Fiat", "Ford", "Freightliner", "Geo", "GMC", "Genesis",
                      "Honda", "Hummer", "Hyundai", "Infinity", "International", "Isuzu",
                      "Jaguar", "Jeep", "Kenworth", "Kia", "Land Rover","Lexus", 
                      "Lincoln", "Mack", "Maserati", "Mazda", "Mercedes-Benz", "Mercury",
                      "Mini", "Mitsubishi", "Nissan", "Oldsmobile", "Peugeot", "Peterbilt", 
                      "Plymoth", "Pontiac", "Porsche", "Ram", "Saab", "Saturn", "Scion", "Seat", 
                      "Smart","Sterling", "Subaru", "Suzuki", "Tesla", "Toyota", "Volkswagen",
                      "Volkswagon", "Volvo"), collapse = "|")
                       
```

```{r}
test_df <- data.frame(manufacturer = c("Ford", "Chevy", NA, NA, NA),
                      model = c("F150", "Chevrolet Silverado", "Chevrolet Silverado", "Dodge Dakota", "toyota 4runner"),
                      description = c("test", "test", "Chevrolet Silverado Truck for Sale", "Dodge Dakota Truck for Sale Toyota", "For sale, toyota 4Runner at Benny's Chevrolet")
                      )

test_df
```

```{r}
pattern <- paste(c("Toyota", "Chevrolet", "Dodge", "Ford"), collapse = "|")

test_df <- test_df %>% 
  #filter(is.na(manufacturer)) %>% 
  mutate(manufacturer = ifelse(is.na(manufacturer), str_to_title(str_extract(test_df$model, regex(man_pattern_2, ignore_case = TRUE))), test_df$manufacturer))

test_df
```

```{r}
cars <- cars %>% 
  #filter(is.na(manufacturer)) %>% 
  mutate(manufacturer = ifelse(is.na(manufacturer), str_to_title(str_extract(cars$model, regex(man_pattern_2, ignore_case = TRUE))), cars$manufacturer))
```

```{r}
cars %>% filter(is.na(manufacturer))
```
```{r}
cars <- cars %>% 
  mutate(manufacturer = ifelse(is.na(manufacturer), 
                               str_to_title(str_extract(cars$description, 
                                                        regex(man_pattern_2, 
                                                              pattern = ignore_case = TRUE)
                                                        )
                                            ), 
                               cars$manufacturer
                               )
         )
```

```{r}
cars %>% filter(is.na(manufacturer)) %>% 
  select(manufacturer, model, description)
```









First we'll try to pull the manufacturer from the model variable.
```{r}
cars$match <- ifelse(is.na(cars$manufacturer),
                          str_extract_all(cars$model, 
                                          regex(manufacturer_pattern, ignore_case = TRUE), 
                                          simplify = TRUE),
                                          ''
                          )
```

```{r}
cars$manufacturer <- ifelse(((is.na(cars$manufacturer)) & (cars$match != '')),
                                 cars$match,
                                 cars$manufacturer
)
```

```{r}
cars %>% filter(is.na(manufacturer))
```
This gets us 8908 more manufacturers in our dataset. Next, we'll try to pull remaining missing manufacturers from the description variable

```{r}
cars <- cars %>% select(-match) # Get rid of match column
```

```{r}
cars$match <- ifelse(is.na(cars$manufacturer),
                          str_extract_all(cars$description, 
                                          regex(manufacturer_pattern, ignore_case = TRUE), 
                                          simplify = TRUE),
                                          ''
                          )
```

```{r}
cars$manufacturer <- ifelse(((is.na(cars$manufacturer)) & (cars$match != '')),
                                 cars$match,
                                 cars$manufacturer
)
```

```{r}
cars %>% filter(is.na(manufacturer)) %>% 
  select(c(year, manufacturer, model, description))
```
We were able to recover 11,975 manufacturers from the model and description columns. We can drop the remaining observations with missing values in the manufacturer column.
```{r}
cars <- cars %>% filter(!is.na(manufacturer))
cars <- cars %>% select(-match)
cars %>% filter(is.na(manufacturer))
```

#### 'model' column
This variable has 5208 missing values.
```{r}
cars %>% filter(is.na(model))
```
If we had more time, we could probably create a list of all known car models and perform the same steps as manufacturer; however, for this analysis, we'll just drop these rows since they only make up about 1% of the total number of observations.

```{r}
cars <- Remove_NAs(cars, "model")
cars %>% filter(is.na(model))
```

#### 'condition' column
```{r}
unique(cars$condition)
```
This seems like a good variable, so we'll just replace the NA values with 'unknown'

```{r}
cars$condition[is.na(cars$condition)] <- "unknown"
unique(cars$condition)
```

#### 'cylinders' column
```{r}
unique(cars$cylinders)
```

similar to condition, we'll replace the NA and "other" values with 'unknown'
```{r}
cars$cylinders[is.na(cars$cylinders)] <- "unknown"
cars$cylinders[cars$cylinders == 'other'] <- "unknown"
unique(cars$cylinders)
```

#### 'fuel' column
```{r}
cars %>% filter(is.na(fuel))
```
We have 2,821 observations with NA values in the 'fuel' column. Let's impute "unknown" for all NA and "other" values.

```{r}
cars$fuel[((cars$fuel == "other") | (cars$fuel == "Other") | is.na(cars$fuel))] <- "unknown"
cars %>% filter(is.na(fuel))
```

#### 'odometer' column
This is a tricky column to deal with. Odometer is likely a really good indicator, so for this dataset, I think it's best to remove all NA 4,189 values.
```{r}
cars %>% filter(is.na(odometer))
```
```{r}
# Remove observations with 'odometer' == NA
cars <- cars %>% filter(!is.na(odometer))
```

We also have quite a few suspect observations. For example, older cars with low mileage.
```{r}

mileage_filter <- (cars$year <= 2018 & cars$odometer < 500)

cars %>% filter(mileage_filter) %>%
  select(c(model, year, condition, odometer )) %>%
  arrange(desc(year))
```
#### Create a function 'Odometer_Filter( )' 
This function will clean the odometer variable based on specific conditions. For example, a 2015 Toyota Camry with 200 miles is probably not accurate and we would probably want to remove these observations from the dataset. This function will allow us to quickly change the filtering when modeling.
```{r}
Odometer_Filter <- function (df, start_year, mileage, remove_na = TRUE) {

  df <- df %>% filter(!is.na(odometer))
  
  mileage_filter <- (df$year <= start_year & df$odometer < mileage)
  df <- df %>% filter(!mileage_filter)
          
  return(df)
  
#' Title: odometer_filter 
#'
#' @param df - dataframe
#' @param start_year - ex: 2018 -> filter out all cars before 2018
#' @param mileage - ex: 500 -> filter out cars with odometer values < 500
#' @param remove_na = TRUE {default}. This removes all NA values from the df
#'
#' @return a dataframe with applied filters
#'
#' @examples odometer_test <- odometer_filter(cars_test, 2018, 500)
  
}
```

Apply the 'odometer_filter' to the dataset.
```{r}
cars <- Odometer_Filter(cars, 2018, 500)
```

#### Remove NA observations in 'title_status' column
```{r}
cars %>% filter(is.na(title_status))
```
```{r}
cars <- Remove_NAs(cars, "title_status")
cars %>% filter(is.na(title_status))
```

```{r}
Number_NAs(cars)
```
#### Clean 'transmission' variable
The 'transmission' variable has 1,557 NA values. We'll convert these to a categorical variable called, 'unknown'. Current categorical variables include:
- 'automatic'
- 'manual'
- 'other'
```{r}
cars %>% filter(transmission == 'other')
```
```{r}
cars %>% count(transmission)
```

```{r}
cars$transmission[is.na(cars$transmission)] <- 'unknown'
```

```{r}
cars %>% count(transmission)
```

# Clean 'drive' column
This column has 30% NA Values. Let's see if we can search the description column and extract some of these values.
```{r}
cars %>% count(cars$drive)
```

```{r}
drive_pattern = "4wd|awd|rwd|fwd"
```


```{r}
cars$match_drive<- ifelse(is.na(cars$drive),
                          str_extract_all(cars$description, 
                                          regex(drive_pattern, ignore_case = TRUE), 
                                          simplify = TRUE),
                                          ''
                          )
```

```{r}
cars %>% filter(match_drive != '')
```
Looks like we were able to recover over 10% of the missing values. We'll impute the remaining values with 'unknown'
```{r}
cars$drive <- ifelse(((is.na(cars$drive)) & (cars$match_drive != '')),
                                 cars$match_drive,
                                 cars$drive
)

cars$drive[is.na(cars$drive)] <- 'unknown'
```

```{r}
cars %>% filter(is.na(drive))
```
Last step is to remove the 'match_drive' column
```{r}
cars <- cars %>% select(-match_drive)
```

#### Clean 'type' column
```{r}
cars %>% count(type)
```
We'll employ the same strategy and as drive and try to extract some values from the description. First step is to create a pattern of vehicle types.
```{r}
type_pattern <- "bus|convertible|coupe|hatchback|mini-van|minivan|
                 offroad|pickup|truck|sedan|SUV|van|wagon"
```

```{r}
cars$match_type<- ifelse(is.na(cars$type),
                          str_extract_all(cars$description, 
                                          regex(type_pattern, ignore_case = TRUE), 
                                          simplify = TRUE),
                                          ''
                          )
```

```{r}
cars %>% filter(match_type != '')
```
We were able to extract 25% of the missing values from the description column. Next we'll impute the NA values with the extracted types and the remaining NAs with 'unknown'.
```{r}
cars$type <- ifelse(((is.na(cars$type)) & (cars$match_type != '')),
                                 cars$match_type,
                                 cars$type
)

cars$type[is.na(cars$type)] <- 'unknown'
```

```{r}
cars %>% filter(is.na(type))
```
There are some mixed case values in this variable so let's set them all to 'lower'. Last, we can remove the 'match_type' column.
```{r}
cars$type <- tolower(cars$type)
cars <- cars %>% select(-match_type)
```

#### Clean 'paint_color' column
This column contains over 25% NA values so once again, let's see if the colors exist in the description.
```{r}
color_pattern <- "red|orange|yellow|green|blue|purple|white|black|grey|silver|brown|gold|beige"
```

```{r}
cars$match_color<- ifelse(is.na(cars$paint_color),
                          str_extract_all(cars$description, 
                                          regex(color_pattern, ignore_case = TRUE), 
                                          simplify = TRUE),
                                          ''
                          )
```

```{r}
cars %>% filter(match_color != '')
```
Excellent. We were able to extract approximately 29% of the missing paint colors from the description column.
```{r}
cars$paint_color <- ifelse(((is.na(cars$paint_color)) & (cars$match_color != '')),
                                 cars$match_color,
                                 cars$paint_color
)

cars$paint_color[is.na(cars$paint_color)] <- 'unknown'
```

```{r}
cars %>% filter(is.na(paint_color))
```

```{r}
cars$paint_color <- tolower(cars$paint_color)
cars <- cars %>% select(-match_color)
```
#### Clean 'description' column
There is only 1 missing value here so we'll just impute it with 'no description'. 
```{r}
cars$description[is.na(cars$description)] <- "no description"
```

#### Check to see if any NA Values Remain in the Dataset.
```{r}
Number_NAs(cars)
```
#### Convert 'manufacturer' and 'model' values to Title Case
```{r}
cars$manufacturer <- str_to_title(cars$manufacturer)
cars$model <- str_to_title(cars$model)
```

#### Extract the first city from the 'region' column. We'll use this column to join other tables.
```{r}
cars$city <- str_split_fixed(cars$region, pattern = "-|/", n = 2)[,1]
```
Convert city to title case.
```{r}
cars$city <- str_to_title(cars$city)
```

```{r}
cars %>% count(city)
```
#### Convert Posting Date to DT Object
```{r}
cars$posting_date <- as.POSIXct(cars$posting_date)
```

```{r}
head(cars)
```

```{r}
colnames(cars)
```


#### Re-arrange column order for easy viewing and create new DF called 'cars_clean'
```{r}
cars <- cars %>% select(id, region, city, state, year, manufacturer, model, 
                        condition, cylinders, fuel, odometer, title_status,
                        transmission, drive, type, paint_color, posting_date, price, description)
```

```{r}
cars_clean <- cars
cars_clean$posting_date <- as.character(cars_clean$posting_date)
head(cars_clean)
```

# Clean Census Data

Establish connection to the database
```{r}
conn <- dbConnect(RSQLite::SQLite(), db_path)
```

```{r}
dbListTables(conn)
```
#### Census Data and zcta mapping file
```{r}
census_df <- dbGetQuery(conn, "SELECT * FROM census_median_income_2020")
```

```{r}
dbDisconnect(conn)
```

#### Inspect 'census_df' first 6 rows
```{r}
head(census_df)
```
```{r}
zcta_df <- read_xlsx('~/Dev/Projects/MGT6203-grp-project/Data_sets/zcta_zip_city_map.xlsx')
```

```{r}
zcta_df
```

#### Subset Census to keep the following variables:
- 'NAME'
- 'S1903_C03_015E' 
- 'S1903_C03_034E'
```{r}
census_df <- census_df[-1,]
census <- subset(census_df, select = c('NAME', 'S1903_C03_015E','S1903_C03_034E'))
census <- census %>%
  rename(zcta = NAME,
         median_income_family = S1903_C03_015E,
         median_income_non_family = S1903_C03_034E
         )

summary(census)
```
```{r}
head(census, 50)
```
#### Change Data Types for Median Columns
```{r}
census$median_income_family <- gsub('+', '', 
                               gsub('-', NaN, census$median_income_family))
```

```{r}
head(census)
```

```{r}
census$median_income_family <- as.numeric(census$median_income_family)
census$median_income_non_family <- as.numeric(census$median_income_non_family)

census <- census %>% drop_na()

head(census)
```
```{r}
summary(census)
```


```{r}
census <- separate(census, zcta, c("zcta", "zip_code"), ' ')
```

```{r}
head(census)
```

```{r}
head(zcta_df)
```


```{r}
census_m <- merge(census, zcta_df, by.x = 'zip_code', by.y = 'ZIP_CODE')
head(census_m)
```

```{r}
census_clean = subset(census_m, select = c("PO_NAME",
                                           "STATE",
                                           "zip_code",
                                           "median_income_family",
                                           "median_income_non_family"))

census_clean = census_clean %>%
  rename("city" = "PO_NAME",
         "state" = "STATE")
```

```{r}
census_clean
```
# Write 'cars_clean' and 'census_clean' back the the SQLite DB

# SQLite3 Database
```{r}
conn <- dbConnect(RSQLite::SQLite(), db_path)
```

```{r}
# View available tables in Database
dbListTables(conn)
```
#### Overwrite Tables?
```{r}
# If you want to overwrite table, change to TRUE
overwrite_table <- TRUE
```

```{r}
# Write the mtcars dataset into a table names mtcars_data
dbWriteTable(conn, "census_clean", census_clean, overwrite = overwrite_table)
dbWriteTable(conn, "cars_clean", cars_clean, field.types = c(posting_date = "text"), overwrite = overwrite_table)
```

```{r}
dbListTables(conn)
dbDisconnect(conn)
```
